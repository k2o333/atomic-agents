
## **“Synapse”智能体平台：系统需求规格说明书 (SRS)**

**文档版本**: 2.0 (Final Architecture)
**基于**: 《集大成终极说明书：统一框架设计手册 (v1.6)》及所有后续优化

### **1. 项目概述 (Overall Description)**

#### **1.1. 产品愿景 (Product Perspective)**
本项目旨在构建一个企业级的、动态的、可运营的多智能体应用平台“Synapse”。Synapse将通过声明式配置和数据驱动的AI智能体，自动化处理和演进企业内部的复杂业务流程，将重复性脑力劳动转化为一个**完全可观测的**、可靠、可审计、可自主优化的智能化操作系统。

#### **1.2. 核心设计原则 (Guiding Principles)**
*   **配置即能力**: 系统的能力由JSON文件声明式定义。
*   **数据即状态**: 持久化数据是系统的唯一事实来源。
*   **引擎即解释器**: 核心引擎是通用工作流语言的解释器。
*   **无状态即美德**: 计算逻辑与状态分离。
*   **多态持久化**: 为不同数据选择最优的、可本地化部署的存储方案。
*   **端到端可观测性**: 所有操作都必须在分布式追踪的上下文中进行。

---

### **2. 核心模块需求 (Module-specific Requirements)**

本系统在逻辑上划分为以下**11个独立的、职责清晰的模块**。

#### **基础设施与适配器层 (Infrastructure & Adapters)**

**模块1: 核心接口 (`interfaces.py`)**
*   **职责**: 定义系统的数据契约。
*   **需求**:
    *   **FR-INT-01**: 必须使用`Pydantic`定义所有跨模块通信的核心数据模型，包括`PlanBlueprint`, `AgentResult`, `ContextBuildConfig`等。
    *   **FR-INT-02**: 所有模型必须清晰、有版本，并作为所有其他模块的**唯一**依赖。

**模块2: 日志与追踪服务 (Logging & Tracing Service)**
*   **职责**: 提供统一的结构化日志和分布式追踪能力。
*   **需求**:
    *   **FR-LOG-01**: 必须提供一个配置化的、输出结构化JSON日志的统一接口。
    *   **FR-LOG-02 (追踪体系)**: 必须实现一个基于`trace_id`（端到端流程）和`span_id`（单次操作）的二级追踪体系。
    *   **FR-LOG-03 (上下文传播)**: 必须使用`ContextVar`等机制实现追踪上下文在异步任务中的自动传播。
    *   **FR-LOG-04 (日志注入)**: 所有日志记录**必须**自动包含当前的`trace_id`和`span_id`。

**模块3: 事件驱动适配器 (Event-Driven Adapters)**
*   **职责**: 连接数据库状态变更与任务队列，消除轮询。
*   **需求**:
    *   **FR-EVT-01 (事件生产者)**: 必须在PostgreSQL的`tasks`表上建立一个**触发器**，在关键状态变更时，自动执行`pg_notify()`。
    *   **FR-EVT-02 (事件处理器)**: 必须有一个独立的**`Notify Handler`**进程，作为`pg_notify`的唯一`LISTEN`者。
    *   **FR-EVT-03 (任务队列)**: `Notify Handler`在接收到通知后，必须将任务ID推入一个**Redis List**作为任务队列。

#### **核心服务层 (Core Services)**

**模块4: 数据库服务 (Persistence Service)**
*   **职责**: 系统与PostgreSQL交互的**唯一**网关。
*   **需求**:
    *   **FR-DB-01**: 必须封装所有SQL/Cypher的CRUD操作。
    *   **FR-DB-02**: 必须管理数据库连接池和事务。
    *   **FR-DB-03 (版本化支持)**: 必须能与`task_history`等版本化历史表进行交互。
    *   **FR-DB-04 (追踪)**: 所有数据库查询**必须**在一个追踪`Span`内执行，并记录关键信息（如查询语句、耗时）。

**模块5: 数据资产版本化服务 (`WorkspaceVersioningService`)**
*   **职责**: 系统与Git工作区交互的**唯一**网关。
*   **需求**:
    *   **FR-WVS-01**: 必须封装所有核心Git命令（`init`, `commit`, `reset`等）。
    *   **FR-WVS-02**: 对文件的每一次写操作都**必须**被记录为一次返回唯一`commit_hash`的Git提交。
    *   **FR-WVS-03**: 必须提供根据`commit_hash`恢复文件或整个工作区状态的能力。

**模块6: 上下文服务 (Context Service)**
*   **职责**: 智能地、按需地为Agent构建提示词。
*   **需求**:
    *   **FR-CTX-01**: 必须能解析Agent的`ContextBuildConfig`请求。
    *   **FR-CTX-02**: 必须能从所有数据域（通过`数据库服务`、`版本化服务`等）拉取数据。
    *   **FR-CTX-03 (融合)**: 必须能根据`prompt_fusion_strategy`，将静态的`base_prompt`和动态生成的提示词进行融合。
    *   **FR-CTX-04 (约束注入)**: 在构建任何上下文的最后一步，**必须**强制注入当前`Workflow`的全局`constraints`。

**模块7: LLM网关服务 (LLM Gateway Service)**
*   **职责**: 系统与所有LLM交互的**唯一**网关。
*   **需求**:
    *   **FR-LLM-01**: 提供OpenAI兼容的统一API，并为无Tool Calling能力的模型提供**模拟实现**。
    *   **FR-LLM-02**: 实现基于Token/次数和多时间窗口的**配额限制**。
    *   **FR-LLM-03**: 提供自动重试、请求缓存和持久化用量记录。
    *   **FR-LLM-04 (追踪)**: 每次对外部LLM的API调用，都**必须**是一个独立的追踪`Span`。

#### **执行器与编排层 (Executors & Orchestration)**

**模块8: 能力初始化服务 (Capability Initializer)**
*   **职责**: 系统的“引导加载程序”，解析`capabilities.json`。
*   **需求**:
    *   **FR-CAP-01**: 必须在系统启动时，加载并严格**验证**`capabilities.json`文件。
    *   **FR-CAP-02**: 必须构建一个内存中的、可被快速查询的**能力注册表**，包含所有Tool, Agent, Group的定义和`implementation_path`。

**模块9: 原生工具服务 (Native Tools Service)**
*   **职责**: 安全地、沙箱化地执行所有Tool脚本。
*   **需求**:
    *   **FR-TLS-01**: 必须能根据`tool_id`，从能力注册表中查找`implementation_path`并动态加载执行。
    *   **FR-TLS-02**: 必须在安全沙箱中执行Tool代码。
    *   **FR-TLS-03 (追踪)**: 每一次Tool的执行，都**必须**是一个独立的追踪`Span`。

**模块10: Agent服务 (Agent Service)**
*   **职责**: 实例化并运行Agent脚本的执行环境。
*   **需求**:
    *   **FR-AGT-01**: 必须能根据`agent_id`，从能力注册表中查找配置和`implementation_path`。
    *   **FR-AGT-02**: 必须能实例化并运行`Generic`和`Custom`两种类型的Agent。
    *   **FR-AGT-03**: Agent的执行输出**必须**严格遵守`AgentResult` v1.1规范。
    *   **FR-AGT-04 (追踪)**: 每一次Agent的`.run()`方法调用，都**必须**是一个独立的追踪`Span`。

**模块11: 中央图引擎 (Central Graph Engine)**
*   **职责**: 系统的“CPU”和“中央调度器”。
*   **需求**:
    *   **FR-ENG-01 (事件驱动)**: 必须通过`BRPOP`从Redis任务队列中消费任务，而非轮询。
    *   **FR-ENG-02 (指令解释)**: 必须能完整地解释并执行`Task`的`directives`（循环、并行、重试、超时等）。
    *   **FR-ENG-03 (条件评估)**: 必须内置一个支持**CEL**的`ConditionEvaluator`。
    *   **FR-ENG-04 (意图处理)**: 必须能正确处理`AgentResult`中的所有`intent`类型，并协调下游服务。
    *   **FR-ENG-05 (追踪)**: 引擎处理单个任务的整个过程，**必须**被包裹在一个顶层的追踪`Span`中，所有其内部调用的服务，都将成为该`Span`的子`Span`。
    *   **FR-ENG-06 (版本控制)**: 必须负责协调数据库状态和文件资产的**联动回滚**。
